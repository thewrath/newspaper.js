<!DOCTYPE html>
<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900,400italic,700italic,900italic|Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="styles/newspaper.css">
        <script
			  src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
        <script src="jaliswall.js"></script>
        <title>Newspaper.js ☕</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
    <div class="head">
        <div class="headerobjectswrapper">
            <!-- <div class="weatherforcastbox"><span style="font-style: italic;">Weatherforcast for the next 24 hours: Plenty of Sunshine</span><br><span>Wind: 7km/h SSE; Ther: 21°C; Hum: 82%</span></div> -->
            <header>NewsPaper.JS ☕</header>
        </div>
        <div class="subhead"></div>
    </div>
    <div class="wall">
      <!-- Content Generate with Ajax Request -->
    </div>
    <div class="greatings">
      <!-- Greating content-->
      <h2>Go coding now !   </h2>
    </div>
    </body>
    <script>
        /**
         * Shuffles array in place. ES6 version
         * @param {Array} a items An array containing the items.
         */
        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        /**
         * Fetch feeds from certified origin 
         * @param {Array} a items An array containing the items.
         */
        function parseFeeds(feeds){
            //get RSS from a certified origin 
            var certified_url = "http://localhost:3000/get_rss/";
            var items = new Array();
            $(".wall").html("");
            feeds.map(feed => $.ajax(certified_url + encodeURIComponent(feed.url), {
                accepts:{
                    xml:"application/rss+xml"
                },
                dataType:"xml",
                success:function(data) {
                    //Credit: http://stackoverflow.com/questions/10943544/how-to-parse-an-rss-feed-using-javascript
                    $(data).find("item").each(function () { // or "item" or whatever suits your feed
                        items.push($(this));
                    });
                    items = shuffle(items);
                    items.forEach(i => {
                        let el = i;
                        if(el.find("title") !== ""){
                            let newArticleImage = document.createElement('img');
                            newArticleImage.style.maxWidth = "10%";
                            newArticleImage.src = (el.find("enclosure").attr('url'))?el.find("enclosure").attr('url'):feed.image;
                            
                            let newArticleHeader =  document.createElement("a");
                            newArticleHeader.href = "test.com";
                            let newArticleHeaderText = document.createElement("h2");
                            newArticleHeader.appendChild(newArticleImage);
                            newArticleHeaderText.innerHTML += " " + el.find("title").text();
                            // newArticleHeader.innerHTML += '<span class="headline hl7">'+el.find("pubDate").text();+'</span>'
                            newArticleHeader.appendChild(newArticleHeaderText);

                                let newArticleContent = document.createElement('p');
                            newArticleContent.innerHTML = el.find('description').text();
                            
                            let newArticle = document.createElement("div");
                            newArticle.className += "wall-item";
                            newArticle.appendChild(newArticleHeader);
                            newArticle.appendChild(newArticleContent);

                            $(".wall").append(newArticle);
                        }
                    });
                    $('.wall').jaliswall({item:'.wall-item'});
            
                },
                error: function(data){
                    console.log(certified_url + encodeURIComponent(feed.url));
                }	
            }));
            
        }

        $(document).ready(function() {
            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            var today = new Date().toLocaleDateString("en-US", options);
            $(".subhead").text("RSS news - "+today+" - Good read");
            //feed to parse
            var feeds =  [
                {url:"http://developpez.com/rss.php", image: "test-dev"}, 
                {url:"https://www.01net.com/rss/actualites/technos/", image: "https://static.bfmtv.com/ressourDces/img/logo/logo-01net-gris.png"},
                {url:"https://korben.info/feed", image: ""}
            ];
            parseFeeds(feeds);
            setInterval(function(){parseFeeds(feeds)}, 600000);
            
        });
    </script>
</html>