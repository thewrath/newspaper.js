<!DOCTYPE html>
<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900,400italic,700italic,900italic|Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <script
			  src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
        <script src="jaliswall.js"></script>
        <title>Newspaper.js ☕</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
    <div class="head">
        <div class="headerobjectswrapper">
            <div class="weatherforcastbox"><span style="font-style: italic;">Weatherforcast for the next 24 hours: Plenty of Sunshine</span><br><span>Wind: 7km/h SSE; Ther: 21°C; Hum: 82%</span></div>
            <header>NewsPaper.JS ☕</header>
        </div>
        <div class="subhead"></div>
    </div>
    <div class="wall">
      <!-- Content Generate with Ajax Request -->
    </div>
    <div class="greatings">
      <!-- Greating content-->
      <h2>Go coding now !</h2>
    </div>
    </body>
    <script>
        /**
         * Randomly shuffle an array
         * https://stackoverflow.com/a/2450976/1293256
         * @param  {Array} array The array to shuffle
         * @return {String}      The first item in the shuffled array
         */
        var shuffle = function (array) {

            var currentIndex = array.length;
            var temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {
                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }

            return array;

        };


        /**
         * Fetch feeds from certified origin 
         * @param {Array} a items An array containing the items.
         */
        function parseFeeds(feeds){
            //get RSS from a certified origin 
            let certified_url = "http://localhost:3000/get_rss/";
            let items = [];
            let articles = [];
            $(".wall").html("");
            feeds.map(feed => $.ajax(certified_url + encodeURIComponent(feed.url), {
                accepts:{
                    xml:"application/rss+xml"
                },
                dataType:"xml",
                success:function(data) {
                    //Credit: http://stackoverflow.com/questions/10943544/how-to-parse-an-rss-feed-using-javascript
                    $(data).find("item").each(function () { // or "item" or whatever suits your feed
                        let el = $(this);
                        if(el.find("title") !== ""){
                            console.log($(this));
                            let newArticleImage = document.createElement('img');
                            newArticleImage.style.maxWidth = "20%";
                            // newArticleImage.src = (el.find("enclosure").attr('url'))?el.find("enclosure").attr('url'):feed.image;
                            newArticleImage.src = feed.image;
                            let newArticleHeader =  document.createElement("a");
                            newArticleHeader.href = el.find('link').text();
                            let newArticleHeaderText = document.createElement("h2");
                            newArticleHeader.appendChild(newArticleImage);
                            newArticleHeaderText.innerHTML += " " + el.find("title").text();
                            // newArticleHeader.innerHTML += '<span class="headline hl7">'+el.find("pubDate").text();+'</span>'
                            newArticleHeader.appendChild(newArticleHeaderText);

                            let newArticleContent = document.createElement('p');
                            newArticleContent.innerHTML = el.find('description').text();
                            
                            let newArticle = document.createElement("div");
                            newArticle.className += "wall-item";
                            newArticle.appendChild(newArticleHeader);
                            newArticle.appendChild(newArticleContent);

                            articles.push(newArticle);
                        }
                    });
                    /*It's better to call this after all rss items has been loaded*/
                    // articles = shuffle(articles);
                    console.log(articles);
                    for (var i = articles.length - 1; i >= 0; i--) {
                        console.log(articles[i]);
                        $(".wall").append(articles[i]);
                        $('.wall').jaliswall({item:'.wall-item'});
                    }
                },
                error: function(data){
                    console.log(certified_url + encodeURIComponent(feed.url));
                }	
            }));
            
        }

        $(document).ready(function() {
            var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            var today = new Date().toLocaleDateString("en-US", options);
            $(".subhead").text("RSS news - "+today+" - Good read");
            //feed to parse
            var feeds =  [
                {url:"http://developpez.com/rss.php", image: "https://pbs.twimg.com/profile_images/482433295758553088/av4cIucb_400x400.jpeg"}, 
                {url:"https://www.01net.com/rss/actualites/technos/", image: "https://pbs.twimg.com/profile_images/877108220250267648/I8cApN1d_400x400.jpg"},
                {url:"https://korben.info/feed", image: "https://tech.korben.info/uploads/default/original/2X/2/2f9b75baaf308cf43d2f0cc56c0826084204c8a7.png"}
            ];
            parseFeeds(feeds);
            setInterval(function(){parseFeeds(feeds)}, 600000);
        });
    </script>
</html>